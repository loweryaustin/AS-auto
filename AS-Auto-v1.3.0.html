<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Call Script Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
<style>
body { font-family: 'Inter', sans-serif; }
.sidebar-item-enter {
    opacity: 0;
    transform: translateX(20px);
    transition: opacity 0.3s ease, transform 0.3s ease;
}
.sidebar-item-enter-active {
    opacity: 1;
    transform: translateX(0);
}
.script-checkbox:checked + span {
    text-decoration: line-through;
    color: #16a34a; /* green-600 */
}
.script-checkbox:checked + span::after {
    content: ' (Symptom Added)';
    font-weight: 600;
}
.prose-dark h2 { color: #fff; border-bottom-color: #4b5563; }
.prose-dark h3 { color: #d1d5db; }
.prose-dark p, .prose-dark label, .prose-dark li { color: #d1d5db; }

/* Style for editable spans (now just placeholders) */
.editable-span {
    padding: 2px 6px;
    border-radius: 4px;
}

/* Timer and Animation Styles */
.timer-segment {
    transition: all 0.3s ease-in-out;
    cursor: pointer;
    overflow: hidden; /* To contain the progress bar */
}
.timer-segment-progress {
    transition: width 0.1s linear;
}

@keyframes flashAndGrow {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.05); opacity: 0.8; }
}
.flash-grow {
    animation: flashAndGrow 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
}
.pulse {
    animation: pulse 1.5s ease-in-out infinite;
}

/* Monospaced font for timers */
.timer-time {
    font-family: 'ui-monospace', 'SFMono-Regular', Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

/* Custom scrollbar for modal */
#settings-modal-content::-webkit-scrollbar {
    width: 8px;
}
#settings-modal-content::-webkit-scrollbar-track {
    background: #374151; /* gray-700 */
    border-radius: 10px;
}
#settings-modal-content::-webkit-scrollbar-thumb {
    background: #6b7280; /* gray-500 */
    border-radius: 10px;
}
#settings-modal-content::-webkit-scrollbar-thumb:hover {
    background: #9ca3af; /* gray-400 */
}

/* Styles for settings modal symptom editor */
.symptom-input-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem; /* 8px */
    padding: 0.75rem; /* 12px */
    background-color: #4b5563; /* gray-600 */
    border-radius: 0.375rem; /* 6px */
}

.symptom-input-group .symptom-input-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.symptom-input-group input[type="text"] {
    flex: 1;
    min-width: 0;
}
.symptom-input-group button {
    flex-shrink: 0;
}
.symptom-input-group textarea {
    width: 100%;
}
.symptom-input-group label {
    font-size: 0.75rem; /* 12px */
    color: #d1d5db; /* gray-300 */
    margin-bottom: 0.25rem; /* 4px */
    display: block;
}


/* Styles for symptom checklist grouping */
.symptom-group-container {
    padding: 1rem; /* 16px */
    background-color: #1f2937; /* gray-800 */
    border-radius: 0.5rem; /* 8px */
}
.symptom-group-header {
    color: #6ee7b7; /* green-300 */
    font-size: 1rem; /* 16px */
    font-weight: 600; /* semibold */
    margin-bottom: 0.75rem; /* 12px */
    border-bottom: 1px solid #374151; /* gray-700 */
    padding-bottom: 0.5rem; /* 8px */
}

/* Styles for sidebar symptom cards */
.sidebar-symptom-card {
    background-color: #374151; /* gray-700 */
    padding: 0.75rem 1rem; /* 12px 16px */
    border-radius: 0.5rem; /* 8px */
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    border-left: 4px solid #6ee7b7; /* green-300 */
}
.sidebar-symptom-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem; /* 8px */
}
.sidebar-symptom-card-supp-name {
    font-size: 0.875rem; /* 14px */
    font-weight: 600; /* semibold */
    color: #a7f3d0; /* green-200 */
}
.sidebar-symptom-card-symptom-text {
    font-size: 1.125rem; /* 18px */
    font-weight: 600; /* semibold */
    color: #ffffff; /* white */
    margin-bottom: 0.5rem; /* 8px */
}
.sidebar-symptom-card-pitch {
    font-size: 0.875rem; /* 14px */
    color: #d1d5db; /* gray-300 */
    font-style: italic;
}

/* NEW: Styles for Import Modal */
.import-textarea {
    width: 100%;
    height: 200px;
    background-color: #374151; /* gray-700 */
    color: #ffffff;
    border: 1px solid #4b5563; /* gray-600 */
    border-radius: 0.5rem;
    padding: 0.75rem;
    font-family: 'ui-monospace', 'SFMono-Regular', Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.875rem;
}

.import-message {
    font-size: 0.875rem; /* 14px */
    font-weight: 600;
    min-height: 1.25rem; /* 20px */
}

.import-message.success {
    color: #6ee7b7; /* green-300 */
}

.import-message.error {
    color: #f87171; /* red-400 */
}

/* NEW: Styles for Search Results */
.search-result-item {
    padding: 0.75rem 1rem; /* 12px 16px */
    color: #d1d5db; /* gray-300 */
    cursor: pointer;
    transition: background-color 0.15s ease;
}
.search-result-item:hover {
    background-color: #4b5563; /* gray-600 */
    color: #ffffff; /* white */
}
.search-result-item:not(:last-child) {
    border-bottom: 1px solid #374151; /* gray-700 */
}
.search-result-empty {
    padding: 0.75rem 1rem; /* 12px 16px */
    color: #9ca3af; /* gray-400 */
    font-style: italic;
}
</style>

</head>
<body class="bg-gray-900 text-gray-200">
    
    <!-- Settings Cog -->
    <button id="settings-cog-btn" class="fixed top-6 left-6 z-50 text-gray-400 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826 3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
    </button>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                <h2 class="text-2xl font-bold text-white">Settings</h2>
                <!-- This span is the injection target for the build script -->
                <span id="app-version" class="text-xs text-gray-500 font-mono"></span>
                <button id="settings-close-btn" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <!-- Settings Content (now scrollable) -->
            <div id="settings-modal-content" class="space-y-6 overflow-y-auto pr-2">
                
                <!-- REMOVED: Active Supplement Switcher -->
                <!-- This is now handled by the main page's search box -->

                <!-- Agent Details -->
                <section>
                    <h3 class="text-lg font-semibold text-gray-300 mb-3">Agent Details</h3>
                    <div>
                        <label for="agent-name-setting" class="block text-sm font-medium text-gray-300 mb-1">Agent Name</label>
                        <input type="text" id="agent-name-setting" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                    </div>
                </section>

                <!-- Timer Segments -->
                <section>
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold text-gray-300">Timer Segments</h3>
                        <button id="add-segment-btn" class="bg-green-600 hover:bg-green-700 text-white text-sm font-bold py-2 px-4 rounded-lg transition-colors">
                            Add Segment
                        </button>
                    </div>
                    <div id="segment-settings-list" class="space-y-3">
                        <!-- Segments will be dynamically inserted here -->
                    </div>
                </section>

                <!-- Supplement Wording -->
                <section>
                    <h3 class="text-lg font-semibold text-yellow-400 mb-3">Edit Current Supplement Wording</h3>
                    
                    <!-- Base Product -->
                    <div class="p-4 bg-gray-900 rounded-lg mb-4">
                        <h4 class="text-md font-semibold text-blue-300 mb-2">Base Product</h4>
                        <div class="space-y-3">
                             <div>
                                <label class="text-xs text-gray-400">Name</label>
                                <input type="text" id="base-product-name-setting" class="w-full bg-gray-700 text-white rounded p-2 text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-gray-400">Pitch (in sidebar)</label>
                                <textarea id="base-product-pitch-setting" rows="2" class="w-full bg-gray-700 text-white rounded p-2 text-sm"></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations -->
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="text-md font-semibold text-green-300">Recommendations</h4>
                        <button id="add-supplement-btn" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-3 rounded-lg transition-colors">
                            Add Supplement
                        </button>
                    </div>
                    <div id="supplement-settings-list" class="space-y-3">
                        <!-- Supplement recommendations will be dynamically inserted here -->
                    </div>
                </section>
            </div>

            <!-- Settings Footer -->
            <div class="border-t border-gray-700 pt-6 flex flex-wrap justify-between items-center gap-4 flex-shrink-0 mt-6">
                <div>
                    <button id="reset-to-defaults-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors text-lg">
                        Reset All
                    </button>
                </div>
                <div class="flex flex-wrap gap-4">
                    <button id="import-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition-colors text-lg">
                        Import
                    </button>
                    <button id="export-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg transition-colors text-lg">
                        Export
                    </button>
                    <button id="settings-save-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors text-lg">
                        Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div id="reset-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-4">Reset for Next Call?</h2>
            <p class="text-gray-300 mb-6">This will clear the client's name, reset the regimen, and reset the call timer. Your saved settings (agent info, timer segments, etc.) will not be affected.</p>
            <div class="flex justify-end gap-4">
                <button id="reset-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="reset-confirm-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                    Reset Call
                </button>
            </div>
        </div>
    </div>
    
    <!-- Reset to Defaults Confirmation Modal -->
    <div id="reset-defaults-confirm-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold text-white mb-4">Reset All Settings & Data?</h2>
            <p class="text-gray-300 mb-6">This will erase ALL your saved data (Agent Name, Segments, and ALL supplement edits) and restore the original defaults. This action cannot be undone.</p>
            <p class="text-yellow-400 font-semibold mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end gap-4">
                <button id="reset-defaults-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="reset-defaults-confirm-btn" class="bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                    Yes, Reset All
                </button>
            </div>
        </div>
    </div>

    <!-- Import Config Modal -->
    <div id="import-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 w-full max-w-xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Import Configuration</h2>
                <button id="import-modal-close-btn" class="text-gray-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <p class="text-gray-300 mb-4">Paste your exported JSON object below. This will overwrite all current settings and supplement data.</p>
            <textarea id="import-textarea" class="import-textarea" placeholder="{ &quot;settings&quot;: {...}, &quot;databases&quot;: {...} }"></textarea>
            <div id="import-message" class="import-message mt-2"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button id="import-cancel-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                    Cancel
                </button>
                <button id="import-confirm-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition-colors">
                    Import & Save
                </button>
            </div>
        </div>
    </div>


    <div class="flex flex-col lg:flex-row min-h-screen">
        
        <!-- Main Script Content -->
        <main class="flex-1 p-6 md:p-10 lg:p-12 overflow-y-auto">
            <div class="max-w-3xl mx-auto prose prose-lg prose-dark">
                
                <!-- Title container -->
                <div class="flex justify-between items-start mb-6"> <!-- Changed to items-start for better alignment -->
                    <!-- NEW: Dynamic Title/Search Component -->
                    <div id="title-search-container" class="relative flex-1">
                        <h1 id="script-title-display" class="text-3xl font-bold text-white mb-0 cursor-pointer hover:text-gray-300 transition-colors">[Script Title]</h1>
                        <input type="text" id="script-search-input" class="hidden w-full max-w-sm bg-gray-700 border-gray-600 text-white rounded-lg p-3 text-2xl font-bold focus:ring-2 focus:ring-blue-500" placeholder="Search supplements..." style="line-height: 1.1;"> <!-- Added line-height -->
                        <div id="script-search-results" class="hidden absolute top-full left-0 w-full max-w-sm bg-gray-700 border border-gray-600 rounded-lg shadow-lg mt-2 z-10 overflow-hidden">
                            <!-- Search results will be populated by script.js -->
                        </div>
                    </div>
                    <!-- Reset Button -->
                    <button id="reset-app-btn" class="text-blue-400 hover:text-blue-300 border border-blue-400 hover:border-blue-300 rounded-lg px-4 py-2 text-sm font-semibold transition-colors ml-4 flex-shrink-0"> <!-- Added flex-shrink-0 -->
                        Next Call
                    </button>
                </div>

                <section class="mb-8">
                    <h2>Part 1: Greeting</h2>
                    <p>Hello, I'm calling for <span class="client-name-placeholder text-yellow-400">[Client Name]</span>?</p>
                    <p>Hi <span class="client-name-placeholder text-yellow-400">[Client Name]</span>. My name is <span id="agent-name-placeholder" class="agent-name-placeholder editable-span text-yellow-400 font-bold">[Agent Name]</span>. I'm a specialist at <span class="base-product-name-script">...</span>, the supplement you ordered online. How are you doing today?</p>
                    <p>The reason I'm calling is you have been assigned as my client, and I reach out to all of my clients onboarding. I'm going to ask you some questions so I can best offer my guidance to help you with this. Okay?</p>
                </section>

                    <h2 class="mt-0">Part 2: Discovery</h2>
                    <div class="space-y-6">
                        <!-- Client Name Input -->
                        <div>
                            <label for="client-name" class="block text-lg font-semibold text-gray-300 mb-2">Client Name:</label>
                            <div class="relative">
                                <input type="text" id="client-name" placeholder="Enter client's name to start timer..." class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 pr-12 focus:ring-2 focus:ring-blue-500">
                                <button id="start-timer-manual-btn" class="absolute right-2 top-1/2 -translate-y-1/2 w-9 h-9 bg-blue-600 hover:bg-blue-700 rounded-full flex items-center justify-center text-white transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Config Dropdowns -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- This hidden select is still used as the source of truth -->
                            <select id="regimen-length" class="hidden">
                                <option value="18" selected>18 Months (Full)</option>
                                <option value="12">12 Months (Walk-down 1)</option>
                                <option value="6">6 Months (Walk-down 2)</option>
                                <option value="3">3 Months (Walk-down 3)</option>
                            </select>
                            
                            <div>
                                <label for="online-bottles" class="block text-sm font-semibold text-gray-300 mb-2">Online Order:</label>
                                <select id="online-bottles" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                                    <option value="0">0 Bottles</option>
                                    <option value="1">1 Bottle</option>
                                    <option value="3">3 Bottles</option>
                                    <option value="6" selected>6 Bottles</option>
                                    <option value="9">9 Bottles</option>
                                    <option value="12">12 Bottles</option>
                                    <option value="15">15 Bottles</option>
                                    <option value="18">18 Bottles</option>
                                </select>
                            </div>
                            <div>
                                <label for="gender" class="block text-sm font-semibold text-gray-300 mb-2">Client Gender:</label>
                                <select id="gender" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                                    <option value="any">Unspecified</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                </select>
                            </div>
                        </div>

                        <!-- Questions -->
                        <p class="font-semibold text-lg mt-4">Questions:</p>
                        <ul class="list-decimal pl-5 space-y-2">
                            <li>How long have you been dealing with this?</li>
                            <li>Are you dealing with any other underlying health conditions such as high blood pressure, cholesterol, or diabetes?</li>
                            <li>Okay, do you take medications for those?</li>
                            <li>How does this affect your life?</li>
                            <li>What is your biggest concern when it to comes to your health?</li>
                        </ul>

                        <!-- Interactive Symptom Checkboxes -->
                        <p class="font-semibold text-lg mt-6">Symptoms Checklist:</p>
                        <!-- This container will be populated by script.js -->
                        <div id="symptom-checklist-container" class="space-y-4">
                            <!-- Dynamically generated symptoms go here -->
                        </div>
                    </div>

                <!-- Part 3: The Tell (Telling not Selling) -->
                <section class="mb-8">
                    <h2>Part 3: The Tell (Telling not Selling)</h2>
                    <p>Okay well <span class="client-name-placeholder text-yellow-400">[Client Name]</span>, I have a really good understanding of your situation now. And based on everything that you'vetold me, I can definitely help you get the results we're looking to see. That being said, I'm going to put you on a very specific regiment that is going to help take care of this. Okay?</p>
                    
                    <p>Great. So for your regiment here, you're going to take your <span id="base-product-name-tell" class="base-product-name-script">...</span> daily, first thing in the morning. Okay?</p>
                    
                    <!-- Dynamic Add-on Pitch -->
                    <div id="dynamic-pitch-content" class="mt-6 p-6 bg-gray-800 rounded-2xl shadow-inner">
                        <p class="italic text-yellow-400">Your personalized add-on pitch will appear here as you select symptoms...</p>
                    </div>

                    <!-- Dynamic Benefits List -->
                    <div id="dynamic-benefits-list" class="mt-6 p-6 bg-gray-800 rounded-2xl shadow-inner">
                         <p class="italic text-yellow-400">Your summary of benefits will appear here...</p>
                    </div>

                    <p>And this regiment here is only going to be for <strong class="text-yellow-400"><span id="pitch-length-1">18</span> months</strong>, and then you're done completely. Okay? So this is not something you're going to do forever. That's because the first <strong class="text-yellow-400"><span id="pitch-length-half">9</span> months</strong> are meant to help you get all of the results I'vementioned. And the reason you take this for another <strong class="text-yellow-400"><span id="pitch-length-half-2">9</span> months</strong> after that is to help your body bio-acclimate and maintain these results on its own. Simply put, once you're done, you're done for good. Does that make sense?</p>
                    
                    <p>Okay perfect. This is all going to be very straight forward. You're going to have the instructions and information on the bottles. But I do like to remind all of my clients that I am your specialist, so if you have any questions, don't hesitate to call me. Okay, <span class="client-name-placeholder text-yellow-400">[Client Name]</span>?</p>
                </section>
                
                <!-- Part 4: The Close -->
                <section class="mb-8">
                    <h2>Part 4: The Close</h2>
                    <p>Alright. And it is going to be this phone number here that I'm calling you from, this <span id="agent-phone-placeholder" class="editable-span text-yellow-400 font-bold">[###]</span> number. And, again, my name is <span class="agent-name-placeholder text-yellow-400 font-bold">[Agent Name]</span>. Feel free to save that in your phone. I'm going to be your main point of contact, so I'll be here to help you monday through friday, 9 to 5 central time. Okay?</p>
                    
                    <p>I do also like to mention, <span class="client-name-placeholder text-yellow-400">[Client Name]</span>, if for some reason you are not seeing any initial results or any improvement within the first <strong class="text-yellow-400">60 days</strong>, just go ahead and give me a call, and we will make sure to get this whole thing refunded to you. Okay? Because we wanna make sure that this is working for you. Okay?</p>
                    
                    <p>Now I'm going to re-verify a couple of pieces of information with you before I get you going on the rest of your regimen. Your shipping address is [ADDRESS] correct? [IF NO, CORRECT IT]. And your email is [EMAIL], is that right? [IF NO, CORRECT IT]</p>
                    
                    <p>Perfect. Alright. Now online, these typically $69 a bottle, but with your specialist discounts, I'm going to bring that all the way down to just <strong class="text-yellow-400">$<span id="pitch-price">45</span> per bottle</strong>. Now we don't save any client card information, so we'll need to get a new card reverified. We accept Visa, Mastercard, or Discover.</p>
                </section>


                <!-- Part 5: Authorization & Closing -->
                <section class="mb-8">
                    <h2>Part 5: Authorization & Closing</h2>
                    
                    <h3>CARD</h3>
                    <p>Okay, let's start with the expiration? ... The cvv on the back? Now let me move us to a
                    non-recorded line so I can get that card number. ... Hello, can you hear me? ... Perfect, what is
                    that card number? ... Let me read it back to you. ... I'm moving us back to that recorded line. ...
                    We’re back on that recorded line. Is the billing address the same as the shipping? [IF NOT, ASK
                    FOR BILLING] And Was there a middle initial or just first and last for the name on the card?</p>

                    <h3 class="mt-6">AUTHO SCRIPT</h3>
                    <p>So now I’m going to read you this authorization statement here. It's going to sound a little
                    repetitive, so bear with me. And I do need to get your okay three times. And like I said, we don't
                    save any client card information. So we don't do any monthly subscriptions. So I'm going to get
                    you out everything that you need from start to finish for the full <strong class="text-yellow-400"><span id="autho-length-1">18</span> months</strong> today. So it'll
                    be a onetime purchase. Okay?</p>
                    
                    <!-- This div will be populated by JS with the correct wording -->
                    <div id="autho-script-dynamic-wording" class="my-4">
                        <p>Now online you've already ordered <strong class="text-yellow-400"><span id="autho-online-bottles">...</span></strong> of the <strong class="text-yellow-400 autho-main-supp-1 base-product-name-script">...</span></strong>. So all I have left to do now is send you <strong class="text-yellow-400"><span id="autho-main-supp-needed">...</span></strong> more of the <strong class="text-yellow-400 autho-main-supp-2 base-product-name-script">...</span></strong> to take that up to <strong class="text-yellow-400"><span id="autho-length-2">18</span></strong>, as well as
                        the <strong class="text-yellow-400"><span id="autho-length-3">18</span>-month</strong> supply of <strong class="text-yellow-400"><span id="autho-addons-list">...</span></strong> to complete your regiment.</p>
                    </div>

                    <p>And with
                    your free shipping and discounts all included, it's only coming out to a one-time additional
                    payment of <strong class="text-yellow-400">$<span id="autho-cost">...</span></strong> US Dollars, and we will put that on the <strong class="text-yellow-400">[CARD TYPE]</strong> ending in <strong class="text-yellow-400">[XXXX]</strong>. Okay?</p>
                    <p>For your safety, I always say it twice. You do authorize the one-time additional payment of the
                    <strong class="text-yellow-400">$<span id="autho-cost-2">...</span></strong> US Dollars on the <strong class="text-yellow-400">[CARD TYPE]</strong> ending in <strong class="text-yellow-400">[XXXX]</strong>, is that correct?</p>
                    
                    <!-- Walkdown Selector (MOVED) -->
                    <div class="my-6 p-4 bg-gray-800 rounded-lg">
                        <label for="autho-regimen-length" class="block text-lg font-semibold text-yellow-400 mb-2">Regimen Length (Walkdown):</label>
                        <p class="text-sm text-gray-400 mb-2 italic">If client has price objection, use this to walk down the price. It will sync and recalculate the script.</p>
                        <select id="autho-regimen-length" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 focus:ring-2 focus:ring-blue-500">
                            <option value="18">18 Months (Full)</option>
                            <option value="12">12 Months (Walk-down 1)</option>
                            <option value="6">6 Months (Walk-down 2)</option>
                            <option value="3">3 Months (Walk-down 3)</option>
                        </select>
                    </div>

                    <h3 class="mt-6">ORDER BREAKDOWN</h3>
                    <p>Perfect, I'll get that sent over to the processing team. In the meantime, I want to go over your
                    order breakdown so you know what's coming out to you. Online, you ordered <strong class="text-yellow-400"><span id="order-online-bottles">...</span></strong> bottle(s) of
                    <strong class="text-yellow-400 class="order-main-supp-1 base-product-name-script"">...</span></strong> for <strong class="text-yellow-400">[ONLINE ORDER COST]</strong>. This was already processed before.</p>
                    
                    <!-- This div will be populated by JS with the correct wording -->
                    <div id="order-breakdown-dynamic-wording" class="my-4">
                        <p>Now with your new order,
                        you'll be getting <strong class="text-yellow-400"><span id="order-main-supp-needed">...</span></strong> additional <strong class="text-yellow-400 order-main-supp-2 base-product-name-script">...</span></strong> and the full <strong class="text-yellow-400"><span id="order-length">18</span>-month</strong> supply of <strong class="text-yellow-400"><span id="order-addons-list">...</span></strong> for the additional <strong class="text-yellow-400">$<span id="order-cost">...</span></strong>.</p>
                    </div>

                    <p>That will complete your
                    regiment and you'll see this coming out in two different packages. Give the order 5 to 7
                    business days to reach you, okay? And for your clarity, the bank statement will be from
                    "Supplement Phone Order."</p>
                    <p>Okay, the company policy enforces me to say this disclaimer, are you ready, I just need you to
                    agree, okay?</p>
                    
                    <p class="my-4 p-4 bg-gray-700 rounded-lg italic border-l-4 border-yellow-500">
                    Now to clarify, I’m obviously not a medical professional, and these supplements aren’t intended
                    to diagnose, treat, cure, or prevent any disease. The FDA has not evaluated these statements.
                    Results vary. Some customers see great benefits, others see no change. If you’re taking
                    prescription medications, check with a healthcare provider. That said, you have nothing to
                    worry about with our <strong class="text-yellow-300">60-day</strong> refund policy. If you’re unsatisfied, just give me a call back and I’ll
                    help set up the return. Does that make sense?
                    </p>
                    
                    <p>Perfect. Give me a quick moment to check in with the processing team... [IF NO -> DECLINE RES
                    | IF YES -> CONTINUE] Alright, the charge did go through.</p>

                    <h3 class="mt-6">CLOSING</h3>
                    <p>Now, each supplement will have the instructions on the label. You will also get an email of the
                    receipt and tracking information. When you get that first package, wait for the second package
                    to get there so you can start all the supplements at the same time. I’m very excited for you to
                    start seeing those results. Did you have any last minute questions I could answer for you? [IF
                    YES, ANSWER | IF NO -> CONTINUE]</p>
                    <p>Alright, I’ll get your package prepared to be sent out. Other than that, I hope you have a great
                    rest of your day. Bye.</p>
                    
                    <hr class="my-6 border-gray-600">
                    
                    <h3 class="mt-6 text-red-400">DECLINE RES</h3>
                    <p>Processing just sent me an email here. They’re letting me know that your bank wants to get
                    your okay on this before we send it out. So go ahead and check your email or your text. You
                    should get a notification. They’re going to ask for your okay and if you recognize the charge
                    amount.</p>
                    
                    <h4 class="mt-4 font-semibold text-yellow-400">IF NOT</h4>
                    <p>Alright, since your bank hasn’t sent you a notification, I’ll have you call them. Let them
                    know you authorize the <strong class="text-yellow-400">$<span id="decline-cost">...</span></strong> from “Supplement Phone Order.” I’ll call you back in 10 or so
                    minutes to finish the authorization. You Should have a number on the back of your card to call.</p>
                    
                    <h4 class="mt-4 font-semibold text-yellow-400">Pick up Card</h4>
                    <p>Means simple decline, will get text/email to verify if they authorized the
                    purchase, or will need to call bank</p>
                </section>

            </div>
        </main>

        <!-- Sidebar -->
        <aside class="w-full lg:w-1/3 xl:w-1/4 bg-gray-800 p-6 shadow-2xl overflow-y-auto lg:sticky lg:top-0 lg:h-screen">
            
            <!-- Notes Section -->
            <div class="mb-6">
                <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-4">Call Notes</h2>
                <div class="space-y-3">
                    <p id="generated-notes" class="text-sm text-gray-300 italic p-3 bg-gray-900 rounded-lg">Pitched: </p>
                    <textarea id="custom-notes" class="w-full bg-gray-700 border-gray-600 text-white rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500" rows="4" placeholder="Add custom notes here..."></textarea>
                    <button id="copy-notes-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                        <span>Copy Notes</span>
                    </button>
                </div>
            </div>

            <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-6">Regimen Preview</h2>
            
            <div id="regimen-list" class="space-y-4">
                <!-- Base Product (Always On) -->
                <div class="bg-gray-700 p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <h3 id="base-product-name-sidebar" class="text-lg font-semibold text-blue-300">...</h3>
                    <p id="base-product-pitch-sidebar" class="text-sm text-gray-300 italic mt-1">...</p>
                </div>
                
                <div id="dynamic-recommendations" class="space-y-4">
                    <!-- Placeholder -->
                    <p id="sidebar-placeholder" class="text-gray-400 italic text-center p-4">Select symptoms from Part 2 to build the regimen.</p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Floating Timer Bar -->
    <div id="floating-timer-bar" class="fixed bottom-4 left-1/2 -translate-x-1/2 flex items-center justify-center gap-2 z-40 p-2 bg-gray-900 bg-opacity-70 backdrop-blur-sm rounded-full shadow-lg">
        <!-- Segments will be dynamically inserted here -->
    </div>

<script>
const SCRIPT_VERSION = '1.3.0';

/**
 * APP_CONFIG
 * This file contains the default *application-level* settings.
 * These are settings that do not change when the supplement database is swapped.
 */
const APP_CONFIG = {
    // Default agent details
    agentName: "[Agent Name]",

    // Default call timer segments
    segments: [
        { id: "seg-1", title: "Listening", duration: 45, progress: 0, state: 'pending', overtime: 0, startTime: null },
        { id: "seg-2", title: "Discovery", duration: 120, progress: 0, state: 'pending', overtime: 0, startTime: null },
        { id: "seg-3", title: "Tell", duration: 240, progress: 0, state: 'pending', overtime: 0, startTime: null },
        { id: "seg-4", title: "Card", duration: 45, progress: 0, state: 'pending', overtime: 0, startTime: null },
        { id: "seg-5", title: "Autho", duration: 180, progress: 0, state: 'pending', overtime: 0, startTime: null },
    ]
};

/**
 * GLPRO_CONFIG
 * Database file for the "GL Pro" supplement.
 */
const GLPRO_CONFIG = {
    "baseProduct": {
        name: "GL Pro (Base)",
        pitch: "This is the base product for diabetes. It helps the pancreas from the *inside*."
    },
    "recommendations": [
        { 
            id: "fpp", 
            name: "FreePain Pro (FPP)", 
            gender: "any",
            symptoms: [
                { 
                    id: "symp-fpp-1", 
                    text: "Tingling or numbness (Neuropathy)",
                    pitch: "For your tingling and numbness... 'That one is going to help with the tingling and numbness in the feet... help the nerves to start to regrow, and help to alleviate some of the pain.'",
                    benefit: "help with the tingling and numbness"
                }
            ]
        },
        { 
            id: "sleep",
            name: "Deep Sleep Pro",
            gender: "any",
            symptoms: [
                { 
                    id: "symp-sleep-1", 
                    text: "Poor Sleep",
                    pitch: "For your sleep issues... 'This one helps with falling asleep and staying asleep, and helps make the sleep you do get more effective and regenerative.'",
                    benefit: "help you get better sleep"
                }
            ]
        },
        { 
            id: "slim",
            name: "Slim Boost Pro / Arctic Burn",
            gender: "any",
            symptoms: [
                { 
                    id: "symp-slim-1", 
                    text: "Need to lose weight",
                    pitch: "For your weight loss goal/energy... 'This one's gonna help with the metabolism, help to retrain it and speed it up... helping your body to focus on metabolizing the fat for more sustained energy.'",
                    benefit: "help you get rid of the excess weight and boost energy"
                }
            ]
        },
        { 
            id: "tmax",
            name: "Tmax Pro",
            gender: "male",
            symptoms: [
                { 
                    id: "symp-tmax-1", 
                    text: "Fatigue / Low Energy",
                    pitch: "For your fatigue and recovery... 'This will boost those natural testosterone levels, helping you feel like a younger man again, but more importantly, helping your body recover like a younger man again.'",
                    benefit: "help with fatigue and recovery"
                },
                { 
                    id: "symp-tmax-2", 
                    text: "Symptoms of ED? (Male Only)",
                    pitch: "For your ED symptoms... 'This will boost those natural testosterone levels... helping your body recover like a younger man again.'",
                    benefit: "help with ED symptoms"
                }
            ]
        },
        { 
            id: "mens",
            name: "Men's Balance Pro",
            gender: "male",
            symptoms: [
                { 
                    id: "symp-mens-1", 
                    text: "Waking up for urination? (Male Only)",
                    pitch: "For waking up to urinate... 'This will help with healthy bladder and prostate function, helping you sleep... and helping your body get rid of the excess sugars more easily.'",
                    benefit: "help with nightly urination"
                }
            ]
        },
        { 
            id: "core",
            name: "Core Vitality Pro",
            gender: "any",
            symptoms: [
                { 
                    id: "symp-core-1", 
                    text: "High Blood Pressure / Cholesterol",
                    pitch: "For your high blood pressure/cholesterol... 'That one's gonna help with circulation, cardiovascular health, as well as helping with healthy bone density.'",
                    benefit: "help with cardiovascular health and circulation"
                }
            ]
        },
        { 
            id: "flora",
            name: "Flora Flo",
            gender: "any",
            symptoms: [
                { 
                    id: "symp-flora-1", 
                    text: "Bloating / Digestion",
                    pitch: "For your bloating... 'This one will help with that bloating issue... help with digestion as well as helping with the good bacterial balance in the gut.'",
                    benefit: "help with bloating and digestion"
                }
            ]
        },
        { 
            id: "sugar",
            name: "FreeSugar Pro",
            gender: "any",
            symptoms: [
                { 
                    id: "symp-sugar-1", 
                    text: "Blood sugar still high",
                    pitch: "For your high blood sugar... 'While the GLPRO is helping the pancreas, this one's gonna be helping with the blood sugar in general, helping it to stay lower longer.'",
                    benefit: "help get your blood sugar under control"
                }
            ]
        }
    ]
};

/**
 * NEURO_CONFIG
 * Database file for the "Neuro Pro" supplement.
 */
const NEURO_CONFIG = {
    "baseProduct": {
        name: "Neuro Pro (Base)",
        pitch: "This is the base product for cognitive function. It helps support brain health and memory."
    },
    "recommendations": [
        { 
            id: "neuro-focus", 
            name: "Focus Max", 
            gender: "any",
            symptoms: [
                { 
                    id: "symp-focus-1", 
                    text: "Brain fog / Trouble concentrating",
                    pitch: "For brain fog... 'This will help clear the cobwebs and support the neurotransmitters responsible for focus and clarity.'",
                    benefit: "help with focus and mental clarity"
                }
            ]
        },
        { 
            id: "neuro-sleep",
            name: "Deep Sleep Pro",
            gender: "any",
            symptoms: [
                { 
                    id: "symp-nsleep-1", 
                    text: "Poor Sleep / Waking up tired",
                    pitch: "For your sleep issues... 'This one helps with falling asleep and staying asleep. Quality sleep is essential for memory consolidation.'",
                    benefit: "help you get restorative sleep"
                }
            ]
        },
        { 
            id: "neuro-calm",
            name: "Calm Support",
            gender: "any",
            symptoms: [
                { 
                    id: "symp-calm-1", 
                    text: "Feeling stressed or anxious",
                    pitch: "For stress... 'This helps balance your cortisol levels. High stress can be very damaging to memory and cognitive function.'",
                    benefit: "help reduce stress and anxiety"
                }
            ]
        }
    ]
};

/**
 * DATABASE_CONFIGS
 * This file collects all individual supplement database configs
 * into one object for the main script to load.
 *
 * The build script (build.sh) ensures this file is loaded *after*
 * all the individual database files.
 */
const DATABASE_CONFIGS = {
    // The key "GL Pro" is the display name in the settings dropdown.
    // The value "GLPRO_CONFIG" is the const variable from the db file.
    "GL Pro": GLPRO_CONFIG,
    "Neuro Pro": NEURO_CONFIG
    // To add another supplement, just add its file to build.sh
    // and add a new line here, e.g.:
    // "ABC Pro": ABCPRO_CONFIG
};

/**
 * ============================================
 * SCRIPT TOOL APPLICATION LOGIC (V6.3)
 * ============================================
 * * This file contains all the business logic for the script tool.
 * * CHANGES (V6.3):
 * - REMOVED the "dev mode" script loader.
 * - The project is now built *only* via the build.sh script.
 */

// --- App State ---

// NEW: Version-gated localStorage keys.
// SCRIPT_VERSION is injected by build.sh
const APP_VERSION = typeof SCRIPT_VERSION !== 'undefined' ? SCRIPT_VERSION : 'dev';
const APP_SETTINGS_KEY = `appSettings_${APP_VERSION}`;
const EDITED_DATABASES_KEY = `editedDatabases_${APP_VERSION}`;
const LAST_DB_NAME_KEY = `lastDbName_${APP_VERSION}`;

// This will be populated by loadState()
let appState = {
    settings: {},           // Holds agentName, segments
    allDatabaseDefaults: {}, // Holds the original, default DBs
    editedDatabases: {},     // Holds user-edited DBs from localStorage
    supplementDatabase: {},  // The *currently active* supplement DB
    currentDbName: null,     // The key of the currently active DB
    currentSegmentIndex: -1,
    globalTimerInterval: null,
    isSettingsOpen: false,
    isSearching: false      // NEW: State for title search
};

// --- DOM CACHE (Query once) ---
const DOM = {};
function cacheDOMElements() {
    DOM.regimenLengthSelect = document.getElementById('regimen-length');
    DOM.authoRegimenLengthSelect = document.getElementById('autho-regimen-length'); 
    DOM.onlineBottlesSelect = document.getElementById('online-bottles');
    DOM.genderSelect = document.getElementById('gender');
    DOM.clientNameInput = document.getElementById('client-name');
    DOM.clientNamePlaceholders = document.querySelectorAll('.client-name-placeholder');
    DOM.agentNamePlaceholders = document.querySelectorAll('.agent-name-placeholder');
    DOM.agentPhonePlaceholder = document.getElementById('agent-phone-placeholder');
    DOM.dynamicPitchContent = document.getElementById('dynamic-pitch-content');
    DOM.dynamicBenefitsList = document.getElementById('dynamic-benefits-list');
    DOM.symptomChecklistContainer = document.getElementById('symptom-checklist-container');
    DOM.dynamicRecommendations = document.getElementById('dynamic-recommendations');
    DOM.sidebarPlaceholder = document.getElementById('sidebar-placeholder');
    DOM.baseProductNameSidebar = document.getElementById('base-product-name-sidebar');
    DOM.baseProductPitchSidebar = document.getElementById('base-product-pitch-sidebar');
    DOM.baseProductNameScriptPlaceholders = document.querySelectorAll('.base-product-name-script');
    DOM.generatedNotes = document.getElementById('generated-notes');
    DOM.customNotes = document.getElementById('custom-notes');
    DOM.copyNotesBtn = document.getElementById('copy-notes-btn');
    DOM.floatingTimerBar = document.getElementById('floating-timer-bar');
    DOM.startTimerManualBtn = document.getElementById('start-timer-manual-btn');
    DOM.settingsCogBtn = document.getElementById('settings-cog-btn');
    DOM.settingsModal = document.getElementById('settings-modal');
    DOM.settingsCloseBtn = document.getElementById('settings-close-btn');
    DOM.settingsSaveBtn = document.getElementById('settings-save-btn');
    DOM.agentNameSettingInput = document.getElementById('agent-name-setting');
    DOM.segmentSettingsList = document.getElementById('segment-settings-list');
    DOM.addSegmentBtn = document.getElementById('add-segment-btn');
    DOM.baseProductNameSetting = document.getElementById('base-product-name-setting');
    DOM.baseProductPitchSetting = document.getElementById('base-product-pitch-setting');
    DOM.supplementSettingsList = document.getElementById('supplement-settings-list');
    DOM.addSupplementBtn = document.getElementById('add-supplement-btn');
    DOM.resetToDefaultsBtn = document.getElementById('reset-to-defaults-btn');
    DOM.resetAppBtn = document.getElementById('reset-app-btn');
    DOM.resetConfirmModal = document.getElementById('reset-confirm-modal');
    DOM.resetConfirmBtn = document.getElementById('reset-confirm-btn');
    DOM.resetCancelBtn = document.getElementById('reset-cancel-btn');
    DOM.resetDefaultsConfirmModal = document.getElementById('reset-defaults-confirm-modal');
    DOM.resetDefaultsConfirmBtn = document.getElementById('reset-defaults-confirm-btn');
    DOM.resetDefaultsCancelBtn = document.getElementById('reset-defaults-cancel-btn');
    DOM.exportBtn = document.getElementById('export-btn');
    DOM.importBtn = document.getElementById('import-btn');
    DOM.importModal = document.getElementById('import-modal');
    DOM.importModalCloseBtn = document.getElementById('import-modal-close-btn');
    DOM.importTextarea = document.getElementById('import-textarea');
    DOM.importConfirmBtn = document.getElementById('import-confirm-btn');
    DOM.importCancelBtn = document.getElementById('import-cancel-btn');
    DOM.importMessage = document.getElementById('import-message');
    // DOM.databaseSwitcher = document.getElementById('database-switcher'); // REMOVED
    // DOM.scriptTitle = document.getElementById('script-title'); // REMOVED

    // NEW: Title Search Elements
    DOM.titleSearchContainer = document.getElementById('title-search-container');
    DOM.scriptTitleDisplay = document.getElementById('script-title-display');
    DOM.scriptSearchInput = document.getElementById('script-search-input');
    DOM.scriptSearchResults = document.getElementById('script-search-results');
}


// --- Utility Functions ---

function simpleDeepMerge(target, source) {
    let output = { ...target };
    for (const key in source) {
        if (source.hasOwnProperty(key)) {
            if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                output[key] = simpleDeepMerge(target[key] || {}, source[key]);
            } else {
                output[key] = source[key];
            }
        }
    }
    return output;
}

function deepCopy(obj) {
    if (typeof obj === 'undefined' || obj === null) {
        console.error("Cannot deep copy undefined or null object.");
        return {};
    }
    try {
        return JSON.parse(JSON.stringify(obj));
    } catch (e) {
        console.error("Failed to deep copy object:", e, obj);
        return {};
    }
}

function getPricePerBottle(months) {
    if (months >= 12) return 45;
    if (months >= 6) return 47;
    return 49;
}

function formatAddonList(names) {
    if (names.length === 0) return "no additional supplements";
    if (names.length === 1) return names[0];
    if (names.length === 2) return names.join(' and ');
    return names.slice(0, -1).join(', ') + ', and '.concat(names.slice(-1));
}

function formatBenefitsList(benefits) {
    if (benefits.length === 0) return "This regimen is designed to help your pancreas heal.";
    let benefitString = "Now, this is going to " + benefits.slice(0, -1).join(', ') + (benefits.length > 1 ? ', and ' : '') + benefits.slice(-1) + ".";
    return benefitString.charAt(0).toUpperCase() + benefitString.slice(1);
}

function formatTime(seconds) {
    const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
    const secs = (seconds % 60).toString().padStart(2, '0');
    return `${mins}:${secs}`;
}

// --- State Management Functions ---

function loadState() {
    // 1. Load default app settings and merge saved app settings
    let savedAppSettings = {};
    try {
        savedAppSettings = JSON.parse(localStorage.getItem(APP_SETTINGS_KEY)) || {};
    } catch (e) {
        console.error("Failed to parse saved appSettings:", e);
    }
    appState.settings = simpleDeepMerge(deepCopy(APP_CONFIG), savedAppSettings);
    appState.settings.segments.forEach(s => {
        s.state = 'pending'; s.progress = 0; s.overtime = 0; s.startTime = null;
    });

    // 2. Load all default supplement databases
    appState.allDatabaseDefaults = deepCopy(DATABASE_CONFIGS);

    // 3. Load all *edited* supplement databases
    try {
        appState.editedDatabases = JSON.parse(localStorage.getItem(EDITED_DATABASES_KEY)) || {};
    } catch (e) {
        console.error("Failed to parse saved editedDatabases:", e);
        appState.editedDatabases = {};
    }

    // 4. Load the last used supplement
    const defaultDbName = Object.keys(appState.allDatabaseDefaults)[0]; // Fallback to the first DB
    const lastDbName = localStorage.getItem(LAST_DB_NAME_KEY) || defaultDbName;
    
    // 5. Populate the DB switcher (REMOVED)
    // DOM.databaseSwitcher.innerHTML = '';
    // ... logic removed ...

    // 6. Load the active supplement config
    loadSupplementDb(lastDbName, false); // false = don't reset call
}

/**
 * Loads a specific supplement database into the active state.
 * @param {string} dbName - The key of the database to load (e.g., "GL Pro")
 * @param {boolean} [resetCall=true] - Whether to reset the call state (timer, client name, etc.)
 */
function loadSupplementDb(dbName, resetCall = true) {
    appState.isSearching = false; // Close search on load
    
    // Add a log to confirm function execution and data
    // console.log(`Loading database: ${dbName}`); // Removed for fix

    let defaultConfig = appState.allDatabaseDefaults[dbName];
    if (!defaultConfig) {
        console.error(`Database "${dbName}" not found. Loading first available.`);
        dbName = Object.keys(appState.allDatabaseDefaults)[0];
        defaultConfig = appState.allDatabaseDefaults[dbName];
    }
    
    const editedConfig = appState.editedDatabases[dbName];
    
    // Merge edited version over the default
    appState.supplementDatabase = simpleDeepMerge(deepCopy(defaultConfig), editedConfig || {});
    appState.currentDbName = dbName;
    localStorage.setItem(LAST_DB_NAME_KEY, dbName);

    // FIX: Removed the call to initAppUI() and am manually calling the
    // necessary render functions in the correct order, AFTER state is set.
    
    // 1. Render the title and sidebar
    updateSupplementWordingUI();
    
    // 2. Render the new symptom checklist
    renderSymptomChecklist();
    
    // 3. Render the script (costs, wording, etc.)
    renderAllScript();

    if (resetCall) {
        resetForNextCall();
    }
}

function saveSettingsToStorage() {
    try {
        // 1. Save app-level settings (agent, segments)
        appState.settings.agentName = appState.settings.agentName;
        appState.settings.segments = appState.settings.segments;
        localStorage.setItem(APP_SETTINGS_KEY, JSON.stringify(appState.settings));

        // 2. Save the *currently edited* supplement DB
        appState.editedDatabases[appState.currentDbName] = appState.supplementDatabase;
        localStorage.setItem(EDITED_DATABASES_KEY, JSON.stringify(appState.editedDatabases));

    } catch (e) {
        console.error("Failed to save settings to localStorage:", e);
    }
}

// --- UI Update Functions (State -> DOM) ---

// NEW: Title/Search UI Functions
function renderTitleUI() {
    if (appState.isSearching) {
        DOM.scriptTitleDisplay.classList.add('hidden');
        DOM.scriptSearchInput.classList.remove('hidden');
        DOM.scriptSearchInput.value = '';
        DOM.scriptSearchInput.focus();
        renderSearchResults('');
    } else {
        DOM.scriptTitleDisplay.classList.remove('hidden');
        DOM.scriptSearchInput.classList.add('hidden');
        DOM.scriptSearchResults.classList.add('hidden');
        
        if (appState.supplementDatabase && appState.supplementDatabase.baseProduct) {
            const baseProductName = appState.supplementDatabase.baseProduct.name.replace(' (Base)', '');
            // ADDED CONSOLE LOG FOR DEBUGGING
            // console.log(`renderTitleUI: Setting title to "${baseProductName} Call Script"`); // Removed for fix
            DOM.scriptTitleDisplay.textContent = `${baseProductName} Call Script`;
        } else {
            // console.log("renderTitleUI: No supplement data, setting default title."); // Removed for fix
            DOM.scriptTitleDisplay.textContent = 'Call Script';
        }
    }
}

function renderSearchResults(query) {
    const lowerQuery = query.toLowerCase();
    const allDbNames = Object.keys(appState.allDatabaseDefaults);
    
    const filteredDbNames = allDbNames.filter(name => 
        name.toLowerCase().includes(lowerQuery)
    );

    if (filteredDbNames.length === 0) {
        DOM.scriptSearchResults.innerHTML = `<div class="search-result-empty">No supplements found.</div>`;
    } else {
        DOM.scriptSearchResults.innerHTML = filteredDbNames.map(name => `
            <div class="search-result-item" data-dbname="${name.replace(/"/g, '&quot;')}">
                ${name}
            </div>
        `).join('');
    }
    DOM.scriptSearchResults.classList.remove('hidden');
}

function closeSearch(e) {
    // Closes search if clicking outside the title/search container
    if (DOM.titleSearchContainer && !DOM.titleSearchContainer.contains(e.target)) {
        if (appState.isSearching) {
            appState.isSearching = false;
            renderTitleUI();
        }
    }
}


function updateAgentNameUI() {
    const displayName = appState.settings.agentName || "[Agent Name]";
    DOM.agentNamePlaceholders.forEach(el => el.textContent = displayName);
}

function updateSupplementWordingUI() {
    // This function now just updates wording in the script/sidebar
    // The title itself is handled by renderTitleUI()
    const baseProduct = appState.supplementDatabase.baseProduct;
    const baseProductName = baseProduct.name.replace(' (Base)', '');

    // Update title
    renderTitleUI();
    
    // Update sidebar
    DOM.baseProductNameSidebar.textContent = baseProduct.name;
    DOM.baseProductPitchSidebar.textContent = baseProduct.pitch;
    
    // Update all placeholders in the main script
    DOM.baseProductNameScriptPlaceholders.forEach(el => {
        el.textContent = baseProductName;
    });
}

function updateClientName(name) {
    const displayName = name || "[Client Name]";
    DOM.clientNamePlaceholders.forEach(el => el.textContent = displayName);
}

function updateTimerControlsVisibility() {
    DOM.startTimerManualBtn.classList.toggle('hidden', appState.currentSegmentIndex !== -1);
}

// --- Timer Functions ---

function renderTimerBar() {
    DOM.floatingTimerBar.innerHTML = '';
    let isCurrentSegmentOvertime = appState.currentSegmentIndex !== -1 && appState.settings.segments[appState.currentSegmentIndex].state === 'overtime';

    appState.settings.segments.forEach((segment, index) => {
        const segmentEl = document.createElement('div');
        segmentEl.dataset.index = index;
        let content = '', progressWidth = '0%', bgClass = 'bg-gray-700 hover:bg-gray-600', animationClass = '', extraSegmentClasses = '';

        switch(segment.state) {
            case 'active':
                const elapsed = (Date.now() - segment.startTime) / 1000;
                const remaining = Math.max(0, segment.duration - elapsed);
                progressWidth = `${Math.min(100, segment.progress)}%`;
                bgClass = 'bg-blue-600';
                content = `<span class="text-sm">${segment.title}</span><span class="timer-time text-lg -mt-1">${formatTime(Math.ceil(remaining))}</span>`;
                if (segment.progress >= 90) animationClass = 'flash-grow';
                break;
            case 'overtime':
                progressWidth = '100%'; bgClass = 'bg-red-600';
                content = `<span class="text-sm">${segment.title}</span><span class="timer-time text-lg -mt-1">+${formatTime(Math.floor(segment.overtime))}</span>`;
                break;
            case 'overtime-complete':
                progressWidth = '100%'; bgClass = 'bg-red-600';
                content = `<span class="text-sm">${segment.title}</span><span class="timer-time text-lg -mt-1">+${formatTime(Math.floor(segment.overtime))}</span>`;
                break;
            case 'complete':
                progressWidth = '100%'; bgClass = 'bg-green-700';
                content = `<span class="text-sm">${segment.title}</span><span class="timer-time text-lg -mt-1">${formatTime(Math.floor(segment.duration))}</span>`;
                break;
            case 'pending':
            default:
                let isNextSegment = index === appState.currentSegmentIndex + 1;
                bgClass = 'bg-gray-700';
                if (isNextSegment || (appState.currentSegmentIndex === -1 && index === 0)) {
                    bgClass += ' hover:bg-gray-600 opacity-100';
                    if (isNextSegment && isCurrentSegmentOvertime) extraSegmentClasses = 'pulse';
                } else {
                    bgClass += ' opacity-60 hover:opacity-80';
                }
                content = `<span class="text-sm">${segment.title}</span><span class="timer-time text-lg -mt-1">${formatTime(segment.duration)}</span>`;
                break;
        }
        segmentEl.className = `timer-segment relative w-36 h-12 flex flex-col items-center justify-center rounded-full text-white font-semibold shadow-md transition-all duration-300 ${extraSegmentClasses}`;
        const progressEl = document.createElement('div');
        progressEl.className = `timer-segment-progress absolute top-0 left-0 h-full rounded-full ${bgClass} ${animationClass}`;
        progressEl.style.width = progressWidth;
        if (segment.state === 'complete' || segment.state === 'overtime' || segment.state === 'active' || segment.state === 'overtime-complete') {
            segmentEl.className += ' bg-gray-600';
        } else {
            segmentEl.className += ` ${bgClass}`;
        }
        segmentEl.innerHTML = `<div class="relative z-10 flex flex-col items-center justify-center">${content}</div>`;
        segmentEl.prepend(progressEl);
        if (animationClass) segmentEl.classList.add(...animationClass.split(' '));
        DOM.floatingTimerBar.appendChild(segmentEl);
    });
}

function updateGlobalTimer() {
    const index = appState.currentSegmentIndex;
    if (index === -1) { stopGlobalTimer(); return; }
    const segment = appState.settings.segments[index];
    if (!segment) return;
    if (segment.state === 'active') {
        const elapsed = (Date.now() - segment.startTime) / 1000;
        segment.progress = (elapsed / segment.duration) * 100;
        if (elapsed >= segment.duration) {
            segment.state = 'overtime'; segment.progress = 100; segment.startTime = Date.now();
        }
    } else if (segment.state === 'overtime') {
        segment.overtime = (Date.now() - segment.startTime) / 1000;
    }
    renderTimerBar();
}

function startGlobalTimer() { if (!appState.globalTimerInterval) appState.globalTimerInterval = setInterval(updateGlobalTimer, 100); }
function stopGlobalTimer() { clearInterval(appState.globalTimerInterval); appState.globalTimerInterval = null; }

function tryStartSegment(index) {
    if (appState.currentSegmentIndex === index && appState.settings.segments[index].state === 'active') return;
    if (appState.currentSegmentIndex === -1 && index === 0) { startSegment(0); return; }
    if (appState.currentSegmentIndex !== -1) {
        const currentSeg = appState.settings.segments[appState.currentSegmentIndex];
        if (index === appState.currentSegmentIndex + 1) {
            currentSeg.state = (currentSeg.state === 'overtime') ? 'overtime-complete' : 'complete';
            currentSeg.progress = 100;
            startSegment(index);
        }
    }
}

function startSegment(index) {
    if (!appState.settings.segments[index]) return;
    appState.currentSegmentIndex = index;
    const segment = appState.settings.segments[index];
    segment.state = 'active'; segment.progress = 0; segment.overtime = 0; segment.startTime = Date.now();
    startGlobalTimer(); renderTimerBar(); updateTimerControlsVisibility();
}

// --- Settings Modal Functions ---

function renderSettingsModal() {
    if (appState.isSettingsOpen) {
        DOM.settingsModal.classList.remove('hidden');
        DOM.agentNameSettingInput.value = appState.settings.agentName;

        // Populate segments
        DOM.segmentSettingsList.innerHTML = '';
        appState.settings.segments.forEach((segment, index) => {
            const segmentEl = document.createElement('div');
            segmentEl.className = 'flex items-center gap-3 p-3 bg-gray-700 rounded-lg';
            segmentEl.dataset.id = segment.id;
            segmentEl.innerHTML = `
                <span class="text-gray-400 font-bold">${index + 1}</span>
                <div class="flex-1">
                    <label class="text-xs text-gray-400">Title</label>
                    <input type="text" value="${segment.title.replace(/"/g, '&quot;')}" class="segment-title-input w-full bg-gray-600 text-white rounded p-2 text-sm">
                </div>
                <div class="w-24">
                    <label class="text-xs text-gray-400">Duration (sec)</label>
                    <input type="number" value="${segment.duration}" class="segment-duration-input w-full bg-gray-600 text-white rounded p-2 text-sm">
                </div>
                <button data-segment-id="${segment.id}" class="remove-segment-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            `;
            DOM.segmentSettingsList.appendChild(segmentEl);
        });

        // Populate Supplement Wording (for *current* DB)
        DOM.baseProductNameSetting.value = appState.supplementDatabase.baseProduct.name;
        DOM.baseProductPitchSetting.value = appState.supplementDatabase.baseProduct.pitch;
        
        DOM.supplementSettingsList.innerHTML = '';
        if (appState.supplementDatabase.recommendations) {
            appState.supplementDatabase.recommendations.forEach(supp => {
                const suppEl = document.createElement('div');
                suppEl.className = 'p-4 bg-gray-700 rounded-lg space-y-3';
                suppEl.dataset.suppId = supp.id;
                
                const safeName = supp.name ? supp.name.replace(/"/g, '&quot;') : "Unnamed Supplement";
                suppEl.innerHTML = `
                    <div class="flex justify-between items-center pb-2 border-b border-gray-600">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400">Supplement Name</label>
                            <input type="text" value="${safeName}" class="supp-name-input w-full bg-gray-600 text-white rounded p-2 text-sm">
                        </div>
                        <select class="supp-gender-select bg-gray-600 text-white rounded p-2 text-sm ml-3">
                            <option value="any" ${supp.gender === 'any' ? 'selected' : ''}>Gender: Any</option>
                            <option value="male" ${supp.gender === 'male' ? 'selected' : ''}>Gender: Male Only</option>
                            <option value="female" ${supp.gender === 'female' ? 'selected' : ''}>Gender: Female Only</option>
                        </select>
                        <button class="remove-supplement-btn bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-3 rounded-lg ml-3">Remove</button>
                    </div>
                    <h5 class="text-sm font-semibold text-gray-300 pt-2 border-t border-gray-600">Symptoms</h5>
                `;

                const symptomsListDiv = document.createElement('div');
                symptomsListDiv.className = 'space-y-2 supp-symptoms-list';
                
                if (supp.symptoms) {
                    supp.symptoms.forEach(symp => {
                        const symptomGroup = document.createElement('div');
                        symptomGroup.className = 'symptom-input-group';
                        symptomGroup.dataset.sympId = symp.id;
                        const safeSympText = symp.text ? symp.text.replace(/"/g, '&quot;') : "";
                        const safeBenefit = symp.benefit ? symp.benefit.replace(/"/g, '&quot;') : "";
                        const safePitch = symp.pitch || "";
                        
                        symptomGroup.innerHTML = `
                            <div class="symptom-input-row">
                                <input type="text" value="${safeSympText}" class="supp-symptom-text-input w-full bg-gray-500 text-white rounded p-2 text-sm" placeholder="Symptom Text">
                                <button class="remove-symptom-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                            </div>
                            <div>
                                <label>Sidebar Pitch</label>
                                <textarea rows="2" class="supp-symptom-pitch-input w-full bg-gray-500 text-white rounded p-2 text-sm" placeholder="Sidebar pitch for this symptom...">${safePitch}</textarea>
                            </div>
                            <div>
                                <label>Script Benefit</label>
                                <input type="text" value="${safeBenefit}" class="supp-symptom-benefit-input w-full bg-gray-500 text-white rounded p-2 text-sm" placeholder="Script benefit for this symptom...">
                            </div>
                        `;
                        symptomsListDiv.appendChild(symptomGroup);
                    });
                }
                suppEl.appendChild(symptomsListDiv);

                const addSymptomBtn = document.createElement('button');
                addSymptomBtn.className = 'add-symptom-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-3 rounded-lg mt-2';
                addSymptomBtn.textContent = 'Add Symptom';
                suppEl.appendChild(addSymptomBtn);
                DOM.supplementSettingsList.appendChild(suppEl);
            });
        }

    } else {
        DOM.settingsModal.classList.add('hidden');
    }
}

function saveSettings() {
    // 1. Save App Settings
    appState.settings.agentName = DOM.agentNameSettingInput.value || "[Agent Name]";
    
    const newSegments = [];
    const segmentElements = DOM.segmentSettingsList.querySelectorAll('[data-id]');
    segmentElements.forEach(el => {
        const id = el.dataset.id;
        const titleInput = el.querySelector('.segment-title-input');
        const durationInput = el.querySelector('.segment-duration-input');
        if (!titleInput || !durationInput) return;
        const title = titleInput.value;
        const duration = parseInt(durationInput.value, 10);
        const existingSegment = appState.settings.segments.find(s => s.id === id) || {};
        newSegments.push({ ...existingSegment, id: id, title: title || "Segment", duration: duration || 60, });
    });
    appState.settings.segments = newSegments;

    // 2. Save *Current* Supplement DB Settings
    appState.supplementDatabase.baseProduct.name = DOM.baseProductNameSetting.value;
    appState.supplementDatabase.baseProduct.pitch = DOM.baseProductPitchSetting.value;
    
    const newRecommendations = [];
    const suppElements = DOM.supplementSettingsList.querySelectorAll('[data-supp-id]');
    suppElements.forEach(el => {
        const suppId = el.dataset.suppId;
        const nameInput = el.querySelector('.supp-name-input');
        const genderSelect = el.querySelector('.supp-gender-select');
        if (!nameInput || !genderSelect) return;
        const newSymptoms = [];
        const symptomElements = el.querySelectorAll('.symptom-input-group');
        symptomElements.forEach(sympEl => {
            const sympId = sympEl.dataset.sympId;
            const sympTextInput = sympEl.querySelector('.supp-symptom-text-input');
            const sympPitchInput = sympEl.querySelector('.supp-symptom-pitch-input');
            const sympBenefitInput = sympEl.querySelector('.supp-symptom-benefit-input');
            if (sympTextInput && sympTextInput.value && sympPitchInput && sympBenefitInput) {
                newSymptoms.push({
                    id: sympId,
                    text: sympTextInput.value,
                    pitch: sympPitchInput.value,
                    benefit: sympBenefitInput.value
                });
            }
        });
        newRecommendations.push({
            id: suppId,
            name: nameInput.value,
            gender: genderSelect.value,
            symptoms: newSymptoms
        });
    });
    appState.supplementDatabase.recommendations = newRecommendations;
    
    // 3. Persist all settings to localStorage
    saveSettingsToStorage();
    
    // 4. Close modal and re-render UI
    appState.isSettingsOpen = false;
    renderSettingsModal();
    initAppUI(); // Full re-render
}

function resetSettingsToDefaults() {
    localStorage.removeItem(APP_SETTINGS_KEY);
    localStorage.removeItem(EDITED_DATABASES_KEY);
    localStorage.removeItem(LAST_DB_NAME_KEY);
    
    loadState();
    initAppUI();
    
    appState.isSettingsOpen = false;
    renderSettingsModal();
    DOM.resetDefaultsConfirmModal.classList.add('hidden');
}

// --- Import/Export Functions ---

function exportConfig() {
    // Export *all* current settings and *all* edited databases
    const configToExport = {
        settings: appState.settings,
        databases: appState.editedDatabases
    };
    
    const exportString = JSON.stringify(configToExport, null, 2);

    const tempTextarea = document.createElement('textarea');
    tempTextarea.style.position = 'absolute'; tempTextarea.style.left = '-9999px';
    tempTextarea.value = exportString;
    document.body.appendChild(tempTextarea);
    tempTextarea.select();
    let success = false;
    try { success = document.execCommand('copy'); } catch (err) { console.error('Failed to copy: ', err); }
    document.body.removeChild(tempTextarea);

    if (success) {
        const originalText = DOM.exportBtn.textContent;
        DOM.exportBtn.textContent = 'Copied!';
        setTimeout(() => { DOM.exportBtn.textContent = originalText; }, 2000);
    }
}

function importConfig() {
    let rawText = DOM.importTextarea.value.trim();
    DOM.importMessage.textContent = '';
    DOM.importMessage.className = 'import-message';

    try {
        const importedConfig = JSON.parse(rawText);
        
        if (!importedConfig.settings || !importedConfig.databases) {
            throw new Error('Invalid config object. Missing `settings` or `databases` keys.');
        }

        // Save to localStorage
        localStorage.setItem('appSettings', JSON.stringify(importedConfig.settings));
        localStorage.setItem('editedDatabases', JSON.stringify(importedConfig.databases));
        
        DOM.importMessage.textContent = 'Success! Reloading application...';
        DOM.importMessage.classList.add('success');

        // Reload the app with new settings
        setTimeout(() => {
            loadState();
            initAppUI();
            DOM.importModal.classList.add('hidden');
            appState.isSettingsOpen = false;
            renderSettingsModal();
        }, 1000);

    } catch (e) {
        console.error("Import failed:", e);
        DOM.importMessage.textContent = `Error: ${e.message}. Please check console.`;
        DOM.importMessage.classList.add('error');
    }
}


// --- Symptom Checklist Rendering ---

function renderSymptomChecklist() {
    const selectedGender = DOM.genderSelect.value;
    DOM.symptomChecklistContainer.innerHTML = '';
    
    if (!appState.supplementDatabase || !appState.supplementDatabase.recommendations) {
        DOM.symptomChecklistContainer.innerHTML = `<p class="italic text-gray-400">No supplement data loaded.</p>`;
        return;
    }

    const filteredSupplements = appState.supplementDatabase.recommendations.filter(supp => {
        return supp.gender === 'any' || supp.gender === selectedGender;
    });

    if (filteredSupplements.length === 0) {
        DOM.symptomChecklistContainer.innerHTML = `<p class="italic text-gray-400">No supplements match the selected gender.</p>`;
        return;
    }

    filteredSupplements.forEach(supp => {
        if (!supp.symptoms || supp.symptoms.length === 0) return; // Robustness check

        const groupEl = document.createElement('div');
        groupEl.className = 'symptom-group-container';
        groupEl.innerHTML = `<h4 class="symptom-group-header">${supp.name}</h4>`;

        const symptomsList = document.createElement('div');
        symptomsList.className = 'space-y-3';

        supp.symptoms.forEach(symp => {
            const label = document.createElement('label');
            label.className = 'flex items-start p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition cursor-pointer';
            const checkboxId = `checkbox-${supp.id}-${symp.id}`;
            label.htmlFor = checkboxId;
            
            label.innerHTML = `
                <input type="checkbox" 
                       class="script-checkbox h-6 w-6 rounded text-blue-500 bg-gray-800 border-gray-600 focus:ring-blue-600 mt-1"
                       id="${checkboxId}"
                       data-supplement-id="${supp.id}"
                       data-symptom-id="${symp.id}">
                <span class="ml-3 text-lg text-gray-200">${symp.text}</span>
            `;
            symptomsList.appendChild(label);
        });

        groupEl.appendChild(symptomsList);
        DOM.symptomChecklistContainer.appendChild(groupEl);
    });
}

// --- Main Script Rendering Function ---

function renderAllScript() {
    const months = parseInt(DOM.regimenLengthSelect.value, 10);
    const onlineBottlesOrdered = parseInt(DOM.onlineBottlesSelect.value, 10);
    const mainSuppName = appState.supplementDatabase.baseProduct.name.replace(' (Base)', '');
    const pricePerBottle = getPricePerBottle(months);

    DOM.authoRegimenLengthSelect.value = months;

    const activeSupplementIds = new Set();
    const checkedBoxes = DOM.symptomChecklistContainer.querySelectorAll('.script-checkbox:checked');
    const activeSymptomsData = [];
    
    checkedBoxes.forEach(cb => {
        const suppId = cb.dataset.supplementId;
        const sympId = cb.dataset.symptomId;
        activeSupplementIds.add(suppId);
        const supp = appState.supplementDatabase.recommendations.find(s => s.id === suppId);
        if (!supp) return;
        const symp = supp.symptoms.find(s => s.id === sympId);
        if (!symp) return;
        activeSymptomsData.push({
            checkboxId: cb.id, suppName: supp.name, sympText: symp.text,
            sympPitch: symp.pitch, sympBenefit: symp.benefit
        });
    });

    const activeRecommendations = appState.supplementDatabase.recommendations.filter(supp => 
        activeSupplementIds.has(supp.id)
    );
    activeRecommendations.sort((a, b) => a.name.localeCompare(b.name));
    
    let addonNames = activeRecommendations.map(rec => rec.name.replace(/\(.*\)/, '').trim());
    let addonListString = formatAddonList(addonNames);

    const numAddOns = activeSupplementIds.size;
    const bottlesOfMainToOrder = Math.max(0, months - onlineBottlesOrdered);
    const bottlesOfAddonsToOrder = months * numAddOns;
    const totalCost = (bottlesOfMainToOrder * pricePerBottle) + (bottlesOfAddonsToOrder * pricePerBottle);
    
    const pitchedSupps = [mainSuppName, ...addonNames];
    DOM.generatedNotes.textContent = 'Pitched: ' + pitchedSupps.join(', ');

    if (activeRecommendations.length === 0) {
        DOM.dynamicPitchContent.innerHTML = `<p class="italic text-yellow-400">No additional symptoms selected. The regimen will only be for ${mainSuppName}.</p>`;
    } else {
        let pitch = `<p>And I'm also going to have you take <strong class="text-yellow-400">${numAddOns}</strong> additional supplement${numAddOns > 1 ? 's' : ''} with the ${mainSuppName}. `;
        if (addonNames.length === 1) {
            pitch += `It's the <strong class="text-green-400">${addonNames[0]}</strong>. Okay?</p>`;
        } else if (addonNames.length === 2) {
            pitch += `The first is <strong class="text-green-400">${addonNames[0]}</strong>, and the second is <strong class="text-green-400">${addonNames[1]}</strong>. Okay?</p>`;
        } else {
             pitch += addonNames.map((name, index) => {
                let ordinal = (index === addonNames.length - 1) ? "And the last one here is" : (index === 0 ? "The first is" : "Second is");
                if(addonNames.length > 3) ordinal = (index === 0 ? "The first is" : (index === addonNames.length - 1) ? "and the last one is" : "the next is");
                return `${ordinal} <strong class="text-green-400">${name}</strong>`;
            }).join(addonNames.length > 3 ? ', ' : '. ') + '. Okay?</p>';
        }
        pitch += `<p>And you don't have to worry about writing any of this down. All of the instructions are going to be on the bottles, and I'll give you my number here so you can reach me if you have any questions throughout. Okay?</p>`;
        DOM.dynamicPitchContent.innerHTML = pitch;
    }
    
    const benefits = activeSymptomsData.map(s => s.sympBenefit);
    DOM.dynamicBenefitsList.innerHTML = `<p class="text-lg">${formatBenefitsList(benefits)} Okay?</p>`;

    DOM.dynamicRecommendations.innerHTML = '';
    if (activeSymptomsData.length === 0) {
        DOM.sidebarPlaceholder.style.display = 'block';
    } else {
        DOM.sidebarPlaceholder.style.display = 'none';
        activeSymptomsData.forEach(symptom => {
            const sidebarEl = document.createElement('div');
            sidebarEl.className = 'sidebar-symptom-card sidebar-item-enter';
            sidebarEl.innerHTML = `
                <div class="sidebar-symptom-card-header">
                    <span class="sidebar-symptom-card-supp-name">${symptom.suppName}</span>
                    <button data-checkbox-id="${symptom.checkboxId}" class="remove-btn text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-full transition-colors">
                        Remove
                    </button>
                </div>
                <h3 class="sidebar-symptom-card-symptom-text">${symptom.sympText}</h3>
                <p class="sidebar-symptom-card-pitch">${symptom.sympPitch}</p>
            `;
            DOM.dynamicRecommendations.appendChild(sidebarEl);
        });
        
        setTimeout(() => {
            document.querySelectorAll('.sidebar-item-enter').forEach(el => {
                el.classList.add('sidebar-item-enter-active');
            });
        }, 10);
    }

    const halfMonths = Math.ceil(months / 2);
    document.getElementById('pitch-length-1').textContent = months;
    document.getElementById('pitch-length-half').textContent = halfMonths;
    document.getElementById('pitch-length-half-2').textContent = months - halfMonths;
    document.getElementById('pitch-price').textContent = pricePerBottle;

    const hasOnlyAddons = (bottlesOfMainToOrder === 0 && bottlesOfAddonsToOrder > 0);
    const hasOnlyMain = (bottlesOfMainToOrder > 0 && bottlesOfAddonsToOrder === 0);
    const hasBoth = (bottlesOfMainToOrder > 0 && bottlesOfAddonsToOrder > 0);
    let authoScriptWording = "", orderBreakdownWording = "";
    const regimenCompletionText = (months < 18) 
        ? `for the first <strong class="text-yellow-400">${months} months</strong> of your regimen` 
        : "to complete your regiment";

    if (hasOnlyAddons) {
        authoScriptWording = `<p>Now online you've already ordered your full <strong class="text-yellow-400">${onlineBottlesOrdered} months</strong> of the <strong class="text-yellow-400">${mainSuppName}</strong>. So all I have left to do now is send you the full <strong class="text-yellow-400">${months}-month</strong> supply of <strong class="text-yellow-400">${addonListString}</strong> ${regimenCompletionText}.</p>`;
        orderBreakdownWording = `<p>Now with your new order, you'll be getting the full <strong class="text-yellow-400">${months}-month</strong> supply of <strong class="text-yellow-400">${addonListString}</strong> for the additional <strong class="text-yellow-400">$<span id="order-cost">${totalCost.toFixed(2)}</span></strong>.</p>`;
    } else if (hasOnlyMain) {
        authoScriptWording = `<p>Now online you've already ordered <strong class="text-yellow-400">${onlineBottlesOrdered}</strong> of the <strong class="text-yellow-400">${mainSuppName}</strong>. So all I have left to do now is send you <strong class="text-yellow-400">${bottlesOfMainToOrder}</strong> more of the <strong class="text-yellow-400">${mainSuppName}</strong> to take that up to <strong class="text-yellow-400">${months}</strong> ${regimenCompletionText}.</p>`;
        orderBreakdownWording = `<p>Now with your new order, you'll be getting <strong class="text-yellow-400">${bottlesOfMainToOrder}</strong> additional <strong class="text-yellow-400">${mainSuppName}</strong> for the additional <strong class="text-yellow-400">$<span id="order-cost">${totalCost.toFixed(2)}</span></strong>.</p>`;
    } else if (hasBoth) {
        authoScriptWording = `<p>Now online you've already ordered <strong class="text-yellow-400">${onlineBottlesOrdered}</strong> of the <strong class="text-yellow-400">${mainSuppName}</strong>. So all I have left to do now is send you <strong class="text-yellow-400">${bottlesOfMainToOrder}</strong> more of the <strong class="text-yellow-400">${mainSuppName}</strong> to take that up to <strong class="text-yellow-400">${months}</strong>, as well as the <strong class="text-yellow-400">${months}-month</strong> supply of <strong class="text-yellow-400">${addonListString}</strong> ${regimenCompletionText}.</p>`;
        orderBreakdownWording = `<p>Now with your new order, you'll be getting <strong class="text-yellow-400">${bottlesOfMainToOrder}</strong> additional <strong class="text-yellow-400">${mainSuppName}</strong> and the full <strong class="text-yellow-400">${months}-month</strong> supply of <strong class="text-yellow-400">${addonListString}</strong> for the additional <strong class="text-yellow-400">$<span id="order-cost">${totalCost.toFixed(2)}</span></strong>.</p>`;
    } else {
        authoScriptWording = `<p>It looks like your order is already complete with <strong class="text-yellow-400">${onlineBottlesOrdered} months</strong> of <strong class="text-yellow-400">${mainSuppName}</strong> and no additional supplements.</p>`;
        orderBreakdownWording = `<p>Now with your new order, it looks like your order is already complete.</p>`;
    }
    
    document.getElementById('autho-length-1').textContent = months;
    document.getElementById('autho-script-dynamic-wording').innerHTML = authoScriptWording;
    document.getElementById('autho-cost').textContent = totalCost.toFixed(2);
    document.getElementById('autho-cost-2').textContent = totalCost.toFixed(2);
    document.getElementById('order-online-bottles').textContent = onlineBottlesOrdered;
    document.getElementById('order-breakdown-dynamic-wording').innerHTML = orderBreakdownWording;
    document.getElementById('decline-cost').textContent = totalCost.toFixed(2);
}

// --- Call Reset Functions ---

function resetForNextCall() {
    stopGlobalTimer();
    appState.currentSegmentIndex = -1;
    appState.settings.segments.forEach(s => { s.state = 'pending'; s.progress = 0; s.overtime = 0; s.startTime = null; });
    DOM.clientNameInput.value = '';
    updateClientName('');
    DOM.symptomChecklistContainer.querySelectorAll('.script-checkbox').forEach(cb => cb.checked = false);
    DOM.authoRegimenLengthSelect.value = '18';
    DOM.regimenLengthSelect.value = '18';
    DOM.customNotes.value = '';
    renderAllScript();
    renderTimerBar();
    updateTimerControlsVisibility();
    DOM.resetConfirmModal.classList.add('hidden');
}


// --- Event Listeners ---

function setupEventListeners() {
    DOM.copyNotesBtn.addEventListener('click', () => {
        const fullNotes = DOM.generatedNotes.textContent + '\n\n' + DOM.customNotes.value;
        const tempTextarea = document.createElement('textarea');
        tempTextarea.style.position = 'absolute'; tempTextarea.style.left = '-9999px';
        tempTextarea.value = fullNotes;
        document.body.appendChild(tempTextarea);
        tempTextarea.select();
        let success = false;
        try { success = document.execCommand('copy'); } catch (err) { console.error('Failed to copy: ', err); }
        document.body.removeChild(tempTextarea);
        if (success) {
            const span = DOM.copyNotesBtn.querySelector('span');
            span.textContent = 'Copied!';
            DOM.copyNotesBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            DOM.copyNotesBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            setTimeout(() => {
                span.textContent = 'Copy Notes';
                DOM.copyNotesBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                DOM.copyNotesBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            }, 2000);
        }
    });

    DOM.symptomChecklistContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('script-checkbox')) renderAllScript();
    });

    DOM.authoRegimenLengthSelect.addEventListener('change', () => {
        DOM.regimenLengthSelect.value = DOM.authoRegimenLengthSelect.value;
        renderAllScript();
    });

    DOM.onlineBottlesSelect.addEventListener('change', renderAllScript);
    DOM.genderSelect.addEventListener('change', () => { renderSymptomChecklist(); renderAllScript(); });

    DOM.clientNameInput.addEventListener('input', () => {
        updateClientName(DOM.clientNameInput.value.trim());
        if (appState.currentSegmentIndex === -1) tryStartSegment(0);
    });

    DOM.startTimerManualBtn.addEventListener('click', () => { if (appState.currentSegmentIndex === -1) tryStartSegment(0); });

    DOM.dynamicRecommendations.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-btn');
        if (removeBtn) {
            const checkboxId = removeBtn.dataset.checkboxId;
            if (checkboxId) {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.checked = false;
                    renderAllScript();
                }
            }
        }
    });

    DOM.resetAppBtn.addEventListener('click', () => DOM.resetConfirmModal.classList.remove('hidden'));
    DOM.resetCancelBtn.addEventListener('click', () => DOM.resetConfirmModal.classList.add('hidden'));
    DOM.resetConfirmBtn.addEventListener('click', resetForNextCall);

    DOM.settingsCogBtn.addEventListener('click', () => { appState.isSettingsOpen = true; renderSettingsModal(); });
    DOM.settingsCloseBtn.addEventListener('click', () => { appState.isSettingsOpen = false; renderSettingsModal(); });
    DOM.settingsSaveBtn.addEventListener('click', saveSettings);

    DOM.addSegmentBtn.addEventListener('click', () => {
        appState.settings.segments.push({
            id: `seg-${Date.now()}`, title: "New Segment", duration: 60,
            progress: 0, state: 'pending', overtime: 0, startTime: null
        });
        renderSettingsModal();
    });

    DOM.segmentSettingsList.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-segment-btn');
        if (removeBtn) {
            const idToRemove = removeBtn.dataset.segmentId;
            appState.settings.segments = appState.settings.segments.filter(s => s.id !== idToRemove);
            renderSettingsModal();
        }
    });

    DOM.supplementSettingsList.addEventListener('click', (e) => {
        const removeSymptomBtn = e.target.closest('.remove-symptom-btn');
        if (removeSymptomBtn) {
            removeSymptomBtn.closest('.symptom-input-group').remove();
            return;
        }

        const addSymptomBtn = e.target.closest('.add-symptom-btn');
        if (addSymptomBtn) {
            const symptomsListDiv = addSymptomBtn.closest('[data-supp-id]').querySelector('.supp-symptoms-list');
            const newSymptomGroup = document.createElement('div');
            newSymptomGroup.className = 'symptom-input-group';
            newSymptomGroup.dataset.sympId = `symp-${Date.now()}`;
            newSymptomGroup.innerHTML = `
                <div class="symptom-input-row">
                    <input type="text" class="supp-symptom-text-input w-full bg-gray-500 text-white rounded p-2 text-sm" placeholder="Symptom Text">
                    <button class="remove-symptom-btn bg-red-600 hover:bg-red-700 text-white p-2 rounded-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
                <div>
                    <label>Sidebar Pitch</label>
                    <textarea rows="2" class="supp-symptom-pitch-input w-full bg-gray-500 text-white rounded p-2 text-sm" placeholder="Sidebar pitch for this symptom..."></textarea>
                </div>
                <div>
                    <label>Script Benefit</label>
                    <input type="text" value="" class="supp-symptom-benefit-input w-full bg-gray-500 text-white rounded p-2 text-sm" placeholder="Script benefit for this symptom...">
                </div>
            `;
            symptomsListDiv.appendChild(newSymptomGroup);
            return;
        }

        const removeSuppBtn = e.target.closest('.remove-supplement-btn');
        if (removeSuppBtn) {
            removeSuppBtn.closest('[data-supp-id]').remove();
            return;
        }
    });

    DOM.addSupplementBtn.addEventListener('click', () => {
        const newSympId = `symp-${Date.now()}`;
        const newSupp = {
            id: `supp-${Date.now()}`, name: "New Supplement", gender: "any",
            symptoms: [
                { id: newSympId, text: "New Symptom", pitch: "", benefit: "" }
            ]
        };
        appState.supplementDatabase.recommendations.push(newSupp);
        renderSettingsModal();
    });
    
    DOM.resetToDefaultsBtn.addEventListener('click', () => DOM.resetDefaultsConfirmModal.classList.remove('hidden'));
    DOM.resetDefaultsCancelBtn.addEventListener('click', () => DOM.resetDefaultsConfirmModal.classList.add('hidden'));
    DOM.resetDefaultsConfirmBtn.addEventListener('click', resetSettingsToDefaults);

    DOM.floatingTimerBar.addEventListener('click', (e) => {
        const segmentEl = e.target.closest('.timer-segment');
        if (segmentEl) tryStartSegment(Number(segmentEl.dataset.index));
    });

    DOM.exportBtn.addEventListener('click', exportConfig);
    DOM.importBtn.addEventListener('click', () => {
        DOM.importModal.classList.remove('hidden');
        DOM.importMessage.textContent = '';
        DOM.importMessage.className = 'import-message';
        DOM.importTextarea.value = '';
    });
    DOM.importModalCloseBtn.addEventListener('click', () => DOM.importModal.classList.add('hidden'));
    DOM.importCancelBtn.addEventListener('click', () => DOM.importModal.classList.add('hidden'));
    DOM.importConfirmBtn.addEventListener('click', importConfig);

    // REMOVED: Old database switcher listener
    // DOM.databaseSwitcher.addEventListener('change', (e) => {
    //     loadSupplementDb(e.target.value);
    // });

    // NEW: Title Search Listeners
    DOM.scriptTitleDisplay.addEventListener('click', () => {
        appState.isSearching = true;
        renderTitleUI();
    });

    // FIX: Removed the "D:" typo which was causing a SyntaxError
    // and preventing subsequent listeners from being attached.
    DOM.scriptSearchInput.addEventListener('input', () => {
        renderSearchResults(DOM.scriptSearchInput.value);
    });

    DOM.scriptSearchResults.addEventListener('click', (e) => {
        const resultItem = e.target.closest('.search-result-item');
        if (resultItem) {
            const dbName = resultItem.dataset.dbname;
            if (dbName) {
                // FIX: Removed redundant calls.
                // Let loadSupplementDb handle all state changes,
                // including closing the search box and re-rendering.
                loadSupplementDb(dbName);
            }
        }
    });

    // Add listener to close search when clicking outside
    document.addEventListener('click', closeSearch);
}

// --- INITIALIZATION ---

/**
 * Renders the entire application UI based on the current appState.
 * This is separated from init() to allow for re-rendering after import.
 */
function initAppUI() {
    updateAgentNameUI();
    updateSupplementWordingUI(); // This will also call renderTitleUI()
    renderSymptomChecklist();
    renderAllScript();
    renderTimerBar();
    updateClientName(DOM.clientNameInput.value);
    updateTimerControlsVisibility();
}

/**
 * Main application entry point.
 */
function init() {
    // 1. Check for critical config files
    if (typeof APP_CONFIG === 'undefined' || typeof DATABASE_CONFIGS === 'undefined') {
        let error = "CRITICAL ERROR: Failed to load config files.";
        if (typeof APP_CONFIG === 'undefined') error += " `APP_CONFIG` is missing. ";
        if (typeof DATABASE_CONFIGS === 'undefined') error += " `DATABASE_CONFIGS` is missing. ";
        console.error(error);
        // Defer the error message slightly to ensure body exists
        setTimeout(() => {
            document.body.innerHTML = `<div style="color: red; padding: 20px;">${error} Check console.</div>`;
        }, 100);
        return;
    }
    
    // 2. Cache all DOM elements
    cacheDOMElements();
    
    // 3. Load initial state from defaults and localStorage
    loadState();
    
    // 4. Set up all event listeners
    setupEventListeners();
    
    // 5. Perform the initial render
    initAppUI();
}

// Wait for the DOM to be fully loaded before running the app
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
